# 데이터베이스 마이그레이션 작업 정리

## 작업 개요
- **작업일**: 2025년 8월 1일
- **목적**: Laravel 유지보수 관리 시스템 데이터베이스 설정
- **환경**: WSL Ubuntu, MySQL, Laravel 12

## 1. 초기 문제 상황

### 1.1 중복 마이그레이션 파일 문제
- 기존 Laravel 기본 마이그레이션 파일들과 커스텀 마이그레이션 파일들이 중복 존재
- 동일한 테이블에 대한 여러 버전의 마이그레이션 파일 존재

### 1.2 외래키 참조 문제
- 모든 테이블의 기본키가 `idx` 컬럼으로 설정됨
- 외래키 참조가 기본 `id` 컬럼을 참조하려고 시도하여 오류 발생

## 2. 해결 과정

### 2.1 중복 파일 정리
삭제된 중복 마이그레이션 파일들:
```
database/migrations/
├── 0001_01_01_000000_create_users_table.php (삭제)
├── 0001_01_01_000001_create_cache_table.php (삭제)
├── 0001_01_01_000002_create_jobs_table.php (삭제)
├── 2025_08_01_045624_create_users_table.php (삭제)
├── 2025_08_01_045632_create_clients_table.php (삭제)
├── 2025_08_01_045833_create_maintenance_types_table.php (삭제)
├── 2025_08_01_045842_create_request_statuses_table.php (삭제)
├── 2025_08_01_045850_create_maintenance_requests_table.php (삭제)
├── 2025_08_01_045901_create_monthly_reports_table.php (삭제)
├── 2025_08_01_045909_create_notices_table.php (삭제)
├── 2025_08_01_045923_create_notifications_table.php (삭제)
└── 2025_08_01_045954_create_attachments_table.php (삭제)
```

### 2.2 마이그레이션 순서 조정
- `users` 테이블이 `clients` 테이블을 참조하므로 순서 조정 필요
- 파일명 변경: `2025_08_01_051955_create_users_table.php` → `2025_08_01_052020_create_users_table.php`

### 2.3 외래키 참조 수정
모든 마이그레이션 파일에서 외래키 참조를 `idx` 컬럼으로 수정:

#### 수정된 파일들:
1. **users 테이블** (`2025_08_01_052020_create_users_table.php`)
   ```php
   $table->foreignId('client_id')->nullable()->constrained('clients', 'idx')->onDelete('set null');
   ```

2. **maintenance_requests 테이블** (`2025_08_01_052118_create_maintenance_requests_table.php`)
   ```php
   $table->foreignId('user_id')->constrained('users', 'idx')->onDelete('cascade');
   $table->foreignId('client_id')->constrained('clients', 'idx')->onDelete('cascade');
   $table->foreignId('manager_id')->nullable()->constrained('users', 'idx')->onDelete('set null');
   $table->foreignId('worker_id')->nullable()->constrained('users', 'idx')->onDelete('set null');
   $table->foreignId('type_id')->constrained('maintenance_types', 'idx')->onDelete('cascade');
   $table->foreignId('status_id')->constrained('request_statuses', 'idx')->onDelete('cascade');
   ```

3. **monthly_reports 테이블** (`2025_08_01_052119_create_monthly_reports_table.php`)
   ```php
   $table->foreignId('client_id')->constrained('clients', 'idx')->onDelete('cascade');
   $table->foreignId('user_id')->constrained('users', 'idx')->onDelete('cascade');
   ```

4. **notices 테이블** (`2025_08_01_052119_create_notices_table.php`)
   ```php
   $table->foreignId('user_id')->constrained('users', 'idx')->onDelete('cascade');
   ```

5. **attachments 테이블** (`2025_08_01_052153_create_attachments_table.php`)
   ```php
   $table->foreignId('request_id')->constrained('maintenance_requests', 'idx')->onDelete('cascade');
   ```

6. **notifications 테이블** (`2025_08_01_052153_create_notifications_table.php`)
   ```php
   $table->foreignId('user_id')->constrained('users', 'idx')->onDelete('cascade');
   ```

## 3. 최종 데이터베이스 구조

### 3.1 생성된 테이블 목록
1. **clients** - 클라이언트 정보
   - `idx` (PK), `name`, `contract_start`, `contract_end`, `website_url`, `created_at`, `updated_at`

2. **users** - 사용자 정보
   - `idx` (PK), `name`, `email`, `password`, `phone`, `position`, `role`, `client_id` (FK), `is_active`, `remember_token`, `created_at`, `updated_at`

3. **maintenance_types** - 유지보수 유형
   - `idx` (PK), `name`, `description`, `created_at`, `updated_at`

4. **request_statuses** - 요청 상태
   - `idx` (PK), `name`, `color`, `description`, `created_at`, `updated_at`

5. **maintenance_requests** - 유지보수 요청
   - `idx` (PK), `user_id` (FK), `client_id` (FK), `manager_id` (FK), `worker_id` (FK), `type_id` (FK), `status_id` (FK), `title`, `content`, `request_date`, `expected_date`, `completed_date`, `created_at`, `updated_at`

6. **monthly_reports** - 월간 보고서
   - `idx` (PK), `client_id` (FK), `user_id` (FK), `year`, `month`, `title`, `content`, `status`, `created_at`, `updated_at`

7. **notices** - 공지사항
   - `idx` (PK), `user_id` (FK), `title`, `content`, `is_important`, `created_at`, `updated_at`

8. **attachments** - 첨부파일
   - `idx` (PK), `request_id` (FK), `file_name`, `file_path`, `file_size`, `file_type`, `created_at`, `updated_at`

9. **notifications** - 알림
   - `idx` (PK), `user_id` (FK), `type`, `title`, `content`, `is_read`, `created_at`, `updated_at`

### 3.2 테이블 관계
```
clients (1) ←→ (N) users
users (1) ←→ (N) maintenance_requests
users (1) ←→ (N) monthly_reports
users (1) ←→ (N) notices
users (1) ←→ (N) notifications
clients (1) ←→ (N) maintenance_requests
clients (1) ←→ (N) monthly_reports
maintenance_types (1) ←→ (N) maintenance_requests
request_statuses (1) ←→ (N) maintenance_requests
maintenance_requests (1) ←→ (N) attachments
```

## 4. 시더 실행 결과

### 4.1 실행된 시더
- **MaintenanceTypeSeeder**: 14개의 유지보수 유형 데이터 생성
- **RequestStatusSeeder**: 6개의 요청 상태 데이터 생성

### 4.2 데이터 확인
```bash
Maintenance Types: 14
Request Statuses: 6
```

## 5. 마이그레이션 상태

### 5.1 최종 마이그레이션 상태
```
Migration name ...................................................................................................... Batch / Status  
2025_08_01_052015_create_clients_table ..................................................................................... [1] Ran  
2025_08_01_052020_create_users_table ....................................................................................... [1] Ran  
2025_08_01_052051_create_maintenance_types_table ........................................................................... [1] Ran  
2025_08_01_052051_create_request_statuses_table ............................................................................ [1] Ran  
2025_08_01_052118_create_maintenance_requests_table ........................................................................ [1] Ran  
2025_08_01_052119_create_monthly_reports_table ............................................................................. [1] Ran  
2025_08_01_052119_create_notices_table ..................................................................................... [1] Ran  
2025_08_01_052153_create_attachments_table ................................................................................. [1] Ran  
2025_08_01_052153_create_notifications_table ............................................................................... [1] Ran  
```

## 6. 작업 완료 사항

✅ **성공적으로 완료된 작업들:**
- 중복 마이그레이션 파일 정리
- 외래키 참조 문제 해결
- 모든 테이블 생성 완료 (9개 테이블)
- 기본 데이터 시더 실행 완료
- MySQL 연결 설정 테스트 완료

## 7. 다음 단계

데이터베이스 설정이 완료되었으므로 다음 작업을 진행할 수 있습니다:
1. 모델 관계 설정
2. 컨트롤러 개발
3. 뷰 템플릿 개발
4. 라우팅 설정
5. 인증 시스템 구현

---

**작업자**: AI Assistant  
**작업일**: 2025년 8월 1일  
**환경**: WSL Ubuntu, MySQL, Laravel 12 
